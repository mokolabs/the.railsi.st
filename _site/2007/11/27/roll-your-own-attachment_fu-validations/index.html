<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>the.rails.ist => Roll your own attachment_fu validations</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link href="http://feeds.feedburner.com/therailsist" rel="alternate" type="application/atom+xml" title="Atom" />
<script src="/javascripts/jquery-1.3.2.min.js" type="text/javascript"></script>
<script src="/javascripts/app.js" type="text/javascript"></script>
<link href="/images/favicon.png" rel="shortcut icon" />
<link rel="stylesheet" href="/stylesheets/app.css" type="text/css" />
<link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" />
</head>
<body>

<div id="page">

<div id="header">
<a href="/">the.railsi.st</a>
</div>

<div id="content">

<div id="sidebar">
<div id="intro">
  
<p>the.railsi.st is <a href="http://mokolabs.com">Patrick Crowley</a>.</p>

<p>I'm a Ruby developer and this blog is a record of my experiences using Ruby on Rails to build web apps.</p>

<p>I also run <a href="http://sdruby.org">SD Ruby</a>, a local Ruby group in San Diego known for its <a href="http://sdruby.org/podcast">podcast</a>.</p>

</div>

<h2>Plugins</h2>

<ul>
<li><a href="/2007/08/22/javascripter-organize-your-javascript">Javascripter</a> - Organize your .js</li>
<li><a href="/2007/05/03/headliner-dry-up-your-page-titles">Headliner</a> - DRY up page titles</li>
<li><a href="/2007/05/03/styler-stylesheets-made-easy">Styler</a> - Stylesheets made easy</li>
</ul>

<h2>Podcasts</h2>

<p>I've given several talks about Ruby.</p>

<ul id="podcasts">
<li><a href="http://sdruby.org/podcast/54"><img src="/images/podcast/7.gif" width="36" height="28" alt="Paperclip" /></a><span><a href="http://sdruby.org/podcast/54">Paperclip</a></span></li>
<li><a href="http://sdruby.org/podcast/38"><img src="/images/podcast/6.gif" width="36" height="28" alt="Headliner &amp; Styler" /></a><span><a href="http://sdruby.org/podcast/38">Haml &amp; Sass</a></span></li>
<li><a href="http://sdruby.org/podcast/27"><img src="/images/podcast/5.gif" width="36" height="28" alt="Headliner &amp; Styler" /></a><span><a href="http://sdruby.org/podcast/27">Headliner &amp; Styler</a></span></li>
<li><a href="http://sdruby.org/podcast/15"><img src="/images/podcast/4.gif" width="36" height="28" alt="Rails for Legacy apps" /></a><span><a href="http://sdruby.org/podcast/15">Rails for Legacy apps</a></span></li>
<li><a href="http://sdruby.org/podcast/17"><img src="/images/podcast/3.gif" width="36" height="27" alt="ActsNaked" /></a><span><a href="http://sdruby.org/podcast/17">ActsNaked</a></span></li>
<li><a href="http://sdruby.org/podcast/11"><img src="/images/podcast/2.gif" width="36" height="28" alt="ActsAsTaggable" /></a><span><a href="http://sdruby.org/podcast/11">ActsAsTaggable</a></span></li>
<li><a href="http://sdruby.org/podcast/1"><img src="/images/podcast/1.gif" width="36" height="28" alt="Summer of Rails" /></a><span><a href="http://sdruby.org/podcast/1">Summer of Rails</a></span></li>
</ul>

<h2>Recent work</h2>

<ul>
<li><a href="http://sdruby.org">SD Ruby</a></li>
<li><a href="http://graffletopia.com">Graffletopia</a></li>
<li><a href="http://measuredvoice.com">Measured Voice</a></li>
<li><a href="http://summerofrails.org">Summer of Rails</a></li>
<li><a href="http://chumby.com">Chumby</a></li>
</ul>

<h2>Consulting</h2>

<p>I'm available for freelance.</p>

<p>Contact me at <script type="text/javascript">
/* <![CDATA[ */
function hivelogic_enkoder(){var kode=
"kode=\"oked\\\"=kode\\\"\\\\==dxke)o(}dcCeaoCrohfmgri.tn=rxS8+1;+2)=<c(0ic"+
"3f);(-AidtCeaocreho.=d{k+ci)h+g;et.ndlkeio0<i;r=f('o=;;'\\\\x\\\\\\\"@\\\\"+
"g{nh0r\\\\00\\\\\\\\,+\\\\gfFhdrFurkipjul1wq@u{V;.4>.5,@?f+3lf6i,>+0DlgwFh"+
"drfuhkr1@g~n.fl,k.j>hw1qgonhlr3?l>u@i+*r@>>*/{-%t-u.4o.py/kkkx4|-x./o-vz4r"+
"jyqkkuuCAjqqj(Cubkj(ius{tk4zx}zobkbbg(n.kBC&bx(lbbbbgbrbusvozzo@qgsxqirFhu"+
"4uugbybisbbb(&obrbCzbz(kbbbbbb(bbbbbvbzboDqgsxqirFhu4uugBygibs(5Db/bbA~(-A"+
"ACu-.lCxAoB6qoj.4ukkmrnt7zA31/8o1C0/\\\\0\\\\\\\\1\\\\q~jC4unkxizgoG7.11u/"+
"kqijg4Gn.x/z3o_3u3kq~j.CB1uokqrjt4zkEmunkqijg4Gn.xuzkqrjt4zk3m/n-7/@(-kAuC"+
"%jhqr@\\\\gn\\\\\\\\=d\\\"ke;o\\\"\\\\kode=kode.split('').reverse().join('"+
"');\\\"=x''f;roi(0=i;(<okedl.netg-h)1i;=+)2x{=+okedc.ahAr(t+i)1k+do.ehcrat"+
"Ai(})okedx=(+<iokedl.netg?hokedc.ahAr(tokedl.netg-h)1':)';\";x='';for(i=0;"+
"i<(kode.length-1);i+=2){x+=kode.charAt(i+1)+kode.charAt(i)}kode=x+(i<kode."+
"length?kode.charAt(kode.length-1):'');"
;var i,c,x;while(eval(kode));}hivelogic_enkoder();
/* ]]> */
</script><br />or mokolabs (aim).</p>

<p id="wwr"><a href="http://www.workingwithrails.com/recommendation/new/person/5945-patrick-crowley"><img src="/images/wwr.gif" alt="Working with Rails" /></a></p>

<p id="feedburner"><a href="http://feeds.feedburner.com/therailsist"><img src="http://feeds.feedburner.com/~fc/therailsist?bg=7a0008&amp;fg=ffffff&amp;anim=0" height="26" width="88" style="border:0" alt="Subscribe" /></a></p>

</div>

<div id="primary">

<h1>Roll your own attachment_fu validations</h1>

<div id="post">
<p>Lots of folks use attachment_fu to handle image uploads. It handles all the dirty work of uploading files, integrates with Amazon S3, and even supports all the different image libraries.</p>

<p>Which is awesome... but it kinda sucks at validating files. Take a pretty typical Photo class:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Photo</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_attachment</span> <span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="ss">:image</span><span class="p">,</span> 
                 <span class="ss">:storage</span> <span class="o">=&gt;</span> <span class="ss">:file_system</span><span class="p">,</span> 
                 <span class="ss">:max_size</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="o">.</span><span class="n">megabytes</span><span class="p">,</span>
                 <span class="ss">:resize_to</span> <span class="o">=&gt;</span> <span class="s1">&#39;320x200&gt;&#39;</span><span class="p">,</span>
                 <span class="ss">:thumbnails</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:thumb</span> <span class="o">=&gt;</span> <span class="s1">&#39;100x100&gt;&#39;</span><span class="p">,</span> <span class="ss">:widget</span> <span class="o">=&gt;</span> <span class="s2">&quot;262x262&gt;&quot;</span> <span class="p">},</span>
                 <span class="ss">:processor</span> <span class="o">=&gt;</span> <span class="no">MiniMagick</span>
  <span class="n">validates_as_attachment</span>

<span class="k">end</span>
</pre>
</div>


<p>What happens when you forget to select a file before uploading?</p>

<ul>
<li>Content type can't be blank</li>
<li>Content type is not included in the list</li>
<li>Size can't be blank</li>
<li>Size is not included in the list</li>
<li>Filename can't be blank</li>
</ul>


<p>So, let's try uploading a Word document:</p>

<ul>
<li>Content type is not included in the list</li>
</ul>


<p>Or a file that's too big:</p>

<ul>
<li>Size is not included in the list</li>
</ul>


<p>Let's try it again, but in English:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Photo</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_attachment</span> <span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="ss">:image</span><span class="p">,</span> 
                 <span class="ss">:storage</span> <span class="o">=&gt;</span> <span class="ss">:file_system</span><span class="p">,</span> 
                 <span class="ss">:max_size</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="o">.</span><span class="n">megabytes</span><span class="p">,</span>
                 <span class="ss">:resize_to</span> <span class="o">=&gt;</span> <span class="s1">&#39;320x200&gt;&#39;</span><span class="p">,</span>
                 <span class="ss">:thumbnails</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:thumb</span> <span class="o">=&gt;</span> <span class="s1">&#39;100x100&gt;&#39;</span><span class="p">,</span> <span class="ss">:widget</span> <span class="o">=&gt;</span> <span class="s2">&quot;262x262&gt;&quot;</span> <span class="p">},</span>
                 <span class="ss">:processor</span> <span class="o">=&gt;</span> <span class="no">MiniMagick</span>
  
  <span class="k">def</span> <span class="nf">validate</span>
    <span class="n">errors</span><span class="o">.</span><span class="n">add_to_base</span><span class="p">(</span><span class="s2">&quot;You must choose a file to upload&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">filename</span>
    
    <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="kp">nil</span>
      
      <span class="c1"># Images should only be GIF, JPEG, or PNG</span>
      <span class="o">[</span><span class="ss">:content_type</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attr_name</span><span class="o">|</span>
        <span class="n">enum</span> <span class="o">=</span> <span class="n">attachment_options</span><span class="o">[</span><span class="n">attr_name</span><span class="o">]</span>
        <span class="k">unless</span> <span class="n">enum</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">enum</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="nb">send</span><span class="p">(</span><span class="n">attr_name</span><span class="p">))</span>
          <span class="n">errors</span><span class="o">.</span><span class="n">add_to_base</span><span class="p">(</span><span class="s2">&quot;You can only upload images (GIF, JPEG, or PNG)&quot;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
      
      <span class="c1"># Images should be less than 5 MB</span>
      <span class="o">[</span><span class="ss">:size</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attr_name</span><span class="o">|</span>
        <span class="n">enum</span> <span class="o">=</span> <span class="n">attachment_options</span><span class="o">[</span><span class="n">attr_name</span><span class="o">]</span>
        <span class="k">unless</span> <span class="n">enum</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">enum</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="nb">send</span><span class="p">(</span><span class="n">attr_name</span><span class="p">))</span>
          <span class="n">errors</span><span class="o">.</span><span class="n">add_to_base</span><span class="p">(</span><span class="s2">&quot;Images should be smaller than 5 MB in size&quot;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
        
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
</div>


<p>To get started, let's drop the <code>validates_as_attachment</code> method. Or, more specifically, try extracting its useful parts into something more useful.</p>

<p>Since we're dropping attachment_fu's validations, we need to roll our own validations for the Photo class. You can do this by declaring a <code>validate</code> method in your class, and adding appropriate logic.</p>

<p>We can also use <code>errors.add_to_base</code> to get total control over your validation messages. By default, Rails pair the model attribute name with an error message ("person" + "is missing an ear"), but sometimes this can lead to awkward phrases ("person is empty").</p>

<p>You'll need to custom this for your application, of course, but this post should give you some examples.</p>

<p>(I'm planning to follow this blog post up with a series of posts about improving validation messages.)</p>


<div class="date">November 27, 2007</div>
</div>


<h2 id="comments">Comments</h2>



<!-- Comment -->
<div class="comment">
<div class="attribution">
<span class="author">Martijn</span>
<span class="date">November 29, 2007</span>
</div>
<div class="body">
<p>Very interesting. Looking forward to those follow-ups.</p>
</div>

<!-- Comment -->
<div class="comment">
<div class="attribution">
<span class="author"><a href="http://toolmantim.com">Tim Lucas</a></span>
<span class="date">December 03, 2007</span>
</div>
<div class="body">
<p>Thanks Pat! I got off my ass and improved my validations. I just posted <a href="http://toolmantim.com/article/2007/12/3/rollin_your_own_attachment_fu_messages_evil_twin_stylee">my stab</a> at a plugin for just this, initially based off your code. I've also posted it to the <a href="http://groups.google.com/group/attachment_fu/">attachment_fu</a> google group for comment.</p>
</div>

<!-- Comment -->
<div class="comment">
<div class="attribution">
<span class="author">rick</span>
<span class="date">March 03, 2008</span>
</div>
<div class="body">
<p>It was done that way on purpose so you could do cool stuff like this.  I figure it's easier to let you define this stuff in Rails, rather than coming up with my own slick DSL that's constantly being updated for everyone's edge cases.</p>
</div>

<!-- Comment -->
<div class="comment">
<div class="attribution">
<span class="author"><a href="http://the.railsi.st">Patrick Crowley</a></span>
<span class="date">March 26, 2008</span>
</div>
<div class="body">
<p>Cool, Rick. It's always nice to have options. :)</p>
</div>

<!-- Comment -->
<div class="comment">
<div class="attribution">
<span class="author"><a href="http://headfirstproductions.ca">Darren</a></span>
<span class="date">April 18, 2008</span>
</div>
<div class="body">
<p>Sweet! This is a nice tutorial for my beginner skills in Ruby. Got my custom errors messages for attachment_fu looking hot!</p>
</div>

<!-- Comment -->
<div class="comment">
<div class="attribution">
<span class="author">Luca G.Soave</span>
<span class="date">May 12, 2008</span>
</div>
<div class="body">
<p>Hi Patrick, </p>

<p>Useful article here, as usual. I'm just moving first steps about attachment_fu, looking for a way to upload  ":other" files type ... say opml files,  do you have some exaples to manage something like :</p>

<p>has_attachment	:content_type => ['text/x-opml', 'application/xml', 'text/xml', 'text/html', 'text/plain'],  ....  and eventually the ":storage => :db_file" way ?</p>

<p>Thanks in advance.
<br />
lgs</p>

<p></p>
</div>




<p class="note">New comments are disabled right now. Once we finish migrating this blog, we'll restore them.</p>
</div>

</div>

</div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-421670-4");
pageTracker._initData();
pageTracker._trackPageview();
</script>
</body>
</html>
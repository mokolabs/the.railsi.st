<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>the.rails.ist @ Roll your own attachment_fu validations</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
</head>
<body>


<h1>Roll your own attachment_fu validations</h1>

<div id="post">
<p>Lots of folks use attachment_fu to handle image uploads. It handles all the dirty work of uploading files, integrates with Amazon S3, and even supports all the different image libraries.</p>

<p>Which is awesome... but it kinda sucks at validating files. Take a pretty typical Photo class:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Photo</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_attachment</span> <span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="ss">:image</span><span class="p">,</span> 
                 <span class="ss">:storage</span> <span class="o">=&gt;</span> <span class="ss">:file_system</span><span class="p">,</span> 
                 <span class="ss">:max_size</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="o">.</span><span class="n">megabytes</span><span class="p">,</span>
                 <span class="ss">:resize_to</span> <span class="o">=&gt;</span> <span class="s1">&#39;320x200&gt;&#39;</span><span class="p">,</span>
                 <span class="ss">:thumbnails</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:thumb</span> <span class="o">=&gt;</span> <span class="s1">&#39;100x100&gt;&#39;</span><span class="p">,</span> <span class="ss">:widget</span> <span class="o">=&gt;</span> <span class="s2">&quot;262x262&gt;&quot;</span> <span class="p">},</span>
                 <span class="ss">:processor</span> <span class="o">=&gt;</span> <span class="no">MiniMagick</span>
  <span class="n">validates_as_attachment</span>

<span class="k">end</span>
</pre>
</div>


<p>What happens when you forget to select a file before uploading?</p>

<ul>
<li>Content type can't be blank</li>
<li>Content type is not included in the list</li>
<li>Size can't be blank</li>
<li>Size is not included in the list</li>
<li>Filename can't be blank</li>
</ul>


<p>So, let's try uploading a Word document:</p>

<ul>
<li>Content type is not included in the list</li>
</ul>


<p>Or a file that's too big:</p>

<ul>
<li>Size is not included in the list</li>
</ul>


<p>Let's try it again, but in English:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Photo</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_attachment</span> <span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="ss">:image</span><span class="p">,</span> 
                 <span class="ss">:storage</span> <span class="o">=&gt;</span> <span class="ss">:file_system</span><span class="p">,</span> 
                 <span class="ss">:max_size</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="o">.</span><span class="n">megabytes</span><span class="p">,</span>
                 <span class="ss">:resize_to</span> <span class="o">=&gt;</span> <span class="s1">&#39;320x200&gt;&#39;</span><span class="p">,</span>
                 <span class="ss">:thumbnails</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:thumb</span> <span class="o">=&gt;</span> <span class="s1">&#39;100x100&gt;&#39;</span><span class="p">,</span> <span class="ss">:widget</span> <span class="o">=&gt;</span> <span class="s2">&quot;262x262&gt;&quot;</span> <span class="p">},</span>
                 <span class="ss">:processor</span> <span class="o">=&gt;</span> <span class="no">MiniMagick</span>
  
  <span class="k">def</span> <span class="nf">validate</span>
    <span class="n">errors</span><span class="o">.</span><span class="n">add_to_base</span><span class="p">(</span><span class="s2">&quot;You must choose a file to upload&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">filename</span>
    
    <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="kp">nil</span>
      
      <span class="c1"># Images should only be GIF, JPEG, or PNG</span>
      <span class="o">[</span><span class="ss">:content_type</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attr_name</span><span class="o">|</span>
        <span class="n">enum</span> <span class="o">=</span> <span class="n">attachment_options</span><span class="o">[</span><span class="n">attr_name</span><span class="o">]</span>
        <span class="k">unless</span> <span class="n">enum</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">enum</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="nb">send</span><span class="p">(</span><span class="n">attr_name</span><span class="p">))</span>
          <span class="n">errors</span><span class="o">.</span><span class="n">add_to_base</span><span class="p">(</span><span class="s2">&quot;You can only upload images (GIF, JPEG, or PNG)&quot;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
      
      <span class="c1"># Images should be less than 5 MB</span>
      <span class="o">[</span><span class="ss">:size</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attr_name</span><span class="o">|</span>
        <span class="n">enum</span> <span class="o">=</span> <span class="n">attachment_options</span><span class="o">[</span><span class="n">attr_name</span><span class="o">]</span>
        <span class="k">unless</span> <span class="n">enum</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">enum</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="nb">send</span><span class="p">(</span><span class="n">attr_name</span><span class="p">))</span>
          <span class="n">errors</span><span class="o">.</span><span class="n">add_to_base</span><span class="p">(</span><span class="s2">&quot;Images should be smaller than 5 MB in size&quot;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
        
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
</div>


<p>To get started, let's drop the <code>validates_as_attachment</code> method. Or, more specifically, try extracting its useful parts into something more useful.</p>

<p>Since we're dropping attachment_fu's validations, we need to roll our own validations for the Photo class. You can do this by declaring a <code>validate</code> method in your class, and adding appropriate logic.</p>

<p>We can also use <code>errors.add_to_base</code> to get total control over your validation messages. By default, Rails pair the model attribute name with an error message ("person" + "is missing an ear"), but sometimes this can lead to awkward phrases ("person is empty").</p>

<p>You'll need to custom this for your application, of course, but this post should give you some examples.</p>

<p>(I'm planning to follow this blog post up with a series of posts about improving validation messages.)</p>

</div>


</body>
</html>
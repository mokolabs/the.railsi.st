<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>the.rails.ist @ Don't use finders with validation helpers</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
</head>
<body>


<h1>Don't use finders with validation helpers</h1>

<div id="post">
<p>Rather innocently, I tried using this validation on my Category model.</p>

<div class="highlight"><pre><span class="n">validates_exclusion_of</span> <span class="ss">:name</span><span class="p">,</span>
                       <span class="ss">:within</span> <span class="o">=&gt;</span> <span class="no">Widget</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">),</span> 
                       <span class="ss">:message</span> <span class="o">=&gt;</span> <span class="s2">&quot;used by a widget&quot;</span>
</pre>
</div>


<p>The idea behind this validation was to make sure a Category doesn't have the same name as a Widget.</p>

<p>But since validations are class methods, they get loaded whenever you access a model. So that means we get an extra SQL query <u>every time</u> we do anything with our Category class, not just on create or update.</p>

<div class="highlight"><pre>User Load <span class="o">(</span>0.001142<span class="o">)</span>   SELECT * FROM widgets LIMIT 1
</pre>
</div>


<p>This might not seem like a big deal, but it's always good practice to keep database calls to a minimum.</p>

<p>So what's the workaround? Use a protected <code>#validate</code> method instead.</p>

<div class="highlight"><pre><span class="k">def</span> <span class="nf">validate</span>
  <span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s2">&quot;used by a widget&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="no">Widget</span><span class="o">.</span><span class="n">find_by_name</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">end</span>
</pre>
</div>


<p>You get the same validation, but without all the extra SQL love.</p>

</div>


</body>
</html>
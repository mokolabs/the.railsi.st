<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>the.rails.ist => Don't use finders with validation helpers</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<script src="/javascripts/jquery-1.3.2.min.js" type="text/javascript"></script>
<script src="/javascripts/app.js" type="text/javascript"></script>
<link href="/images/favicon.png" rel="shortcut icon" />
<link rel="stylesheet" href="/stylesheets/app.css" type="text/css" />
<link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" />
</head>
<body>

<div id="page">

<div id="header">
<a href="/">the.railsi.st</a>
</div>

<div id="content">

<div id="sidebar">
<h2>About</h2>

<p>the.railsi.st is <a href="http://mokolabs.com">Patrick Crowley</a>.</p>

<p>I'm a Rails developer and this blog is a record of my experiences using Ruby on Rails to build web apps.</p>

<p>I also run <a href="http://sdruby.org">SD Ruby</a>, a local Ruby group in San Diego known for its <a href="http://sdruby.org/podcast">podcast</a>.</p>

<h2>Plugins</h2>

<ul>
<li><a href="/2007/08/22/javascripter-organize-your-javascript">Javascripter</a> - Organize your .js</li>
<li><a href="/2007/05/03/headliner-dry-up-your-page-titles">Headliner</a> - DRY up page titles</li>
<li><a href="/2007/05/03/styler-stylesheets-made-easy">Styler</a> - Stylesheets made easy</li>
</ul>

<h2>Podcasts</h2>

<p>I've given several talks about Rails.</p>

<ul id="podcasts">
<li><a href="http://sdruby.org/podcast/54"><img src="/images/podcast/7.gif" width="36" height="28" alt="Paperclip" /></a><span><a href="http://sdruby.org/podcast/54">Paperclip</a></span></li>
<li><a href="http://sdruby.org/podcast/38"><img src="/images/podcast/6.gif" width="36" height="28" alt="Headliner &amp; Styler" /></a><span><a href="http://sdruby.org/podcast/38">Haml &amp; Sass</a></span></li>
<li><a href="http://sdruby.org/podcast/27"><img src="/images/podcast/5.gif" width="36" height="28" alt="Headliner &amp; Styler" /></a><span><a href="http://sdruby.org/podcast/27">Headliner &amp; Styler</a></span></li>
<li><a href="http://sdruby.org/podcast/15"><img src="/images/podcast/4.gif" width="36" height="28" alt="Rails for Legacy apps" /></a><span><a href="http://sdruby.org/podcast/15">Rails for Legacy apps</a></span></li>
<li><a href="http://sdruby.org/podcast/17"><img src="/images/podcast/3.gif" width="36" height="27" alt="ActsNaked" /></a><span><a href="http://sdruby.org/podcast/17">ActsNaked</a></span></li>
<li><a href="http://sdruby.org/podcast/11"><img src="/images/podcast/2.gif" width="36" height="28" alt="ActsAsTaggable" /></a><span><a href="http://sdruby.org/podcast/11">ActsAsTaggable</a></span></li>
<li><a href="http://sdruby.org/podcast/1"><img src="/images/podcast/1.gif" width="36" height="28" alt="Summer of Rails" /></a><span><a href="http://sdruby.org/podcast/1">Summer of Rails</a></span></li>
</ul>

<h2>Recent work</h2>

<ul>
<li><a href="http://chumby.com">Chumby</a></li>
<li><a href="http://roxy.cinematreasures.org">Roxy</a></li>
<li><a href="http://graffletopia.com">Graffletopia</a></li>
<li><a href="http://sdruby.org">SD Ruby</a></li>
<li><a href="http://summerofrails.org">Summer of Rails</a></li>
</ul>

<h2>Consulting</h2>

<p>I'm available for freelance.</p>

<p id="merbcamp"><a href="http://merbcamp.com"><img src="/images/merbcamp.gif" width="200" height="115" alt="I'm attending MerbCamp" /></a></p>

<p id="wwr"><a href="http://www.workingwithrails.com/recommendation/new/person/5945-patrick-crowley"><img src="/images/wwr.gif" /></a></p>

<p id="feedburner"><a href="http://feeds.feedburner.com/therailsist"><img src="http://feeds.feedburner.com/~fc/therailsist?bg=7a0008&amp;fg=ffffff&amp;anim=0" height="26" width="88" style="border:0" alt="Subscribe" /></a></p>
</div>

<div id="primary">

<h1>Don't use finders with validation helpers</h1>

<div id="post">
<p>Rather innocently, I tried using this validation on my Category model.</p>

<div class="highlight"><pre><span class="n">validates_exclusion_of</span> <span class="ss">:name</span><span class="p">,</span>
                       <span class="ss">:within</span> <span class="o">=&gt;</span> <span class="no">Widget</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">),</span> 
                       <span class="ss">:message</span> <span class="o">=&gt;</span> <span class="s2">&quot;used by a widget&quot;</span>
</pre>
</div>


<p>The idea behind this validation was to make sure a Category doesn't have the same name as a Widget.</p>

<p>But since validations are class methods, they get loaded whenever you access a model. So that means we get an extra SQL query <u>every time</u> we do anything with our Category class, not just on create or update.</p>

<div class="highlight"><pre>User Load <span class="o">(</span>0.001142<span class="o">)</span>   SELECT * FROM widgets LIMIT 1
</pre>
</div>


<p>This might not seem like a big deal, but it's always good practice to keep database calls to a minimum.</p>

<p>So what's the workaround? Use a protected <code>#validate</code> method instead.</p>

<div class="highlight"><pre><span class="k">def</span> <span class="nf">validate</span>
  <span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s2">&quot;used by a widget&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="no">Widget</span><span class="o">.</span><span class="n">find_by_name</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">end</span>
</pre>
</div>


<p>You get the same validation, but without all the extra SQL love.</p>

</div>


</div>

</div>

</div>

</body>
</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>the.rails.ist => How to customize attachment_fu file names</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<script src="/javascripts/jquery-1.3.2.min.js" type="text/javascript"></script>
<script src="/javascripts/app.js" type="text/javascript"></script>
<link href="/images/favicon.png" rel="shortcut icon" />
<link rel="stylesheet" href="/stylesheets/app.css" type="text/css" />
<link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" />
</head>
<body>

<div id="page">

<div id="header">
<a href="/">the.railsi.st</a>
</div>

<div id="content">

<div id="sidebar">
<h2>About</h2>

<p>the.railsi.st is <a href="http://mokolabs.com">Patrick Crowley</a>.</p>

<p>I'm a Ruby developer and this blog is a record of my experiences using Ruby on Rails to build web apps.</p>

<p>I also run <a href="http://sdruby.org">SD Ruby</a>, a local Ruby group in San Diego known for its <a href="http://sdruby.org/podcast">podcast</a>.</p>

<h2>Plugins</h2>

<ul>
<li><a href="/2007/08/22/javascripter-organize-your-javascript">Javascripter</a> - Organize your .js</li>
<li><a href="/2007/05/03/headliner-dry-up-your-page-titles">Headliner</a> - DRY up page titles</li>
<li><a href="/2007/05/03/styler-stylesheets-made-easy">Styler</a> - Stylesheets made easy</li>
</ul>

<h2>Podcasts</h2>

<p>I've given several talks about Ruby.</p>

<ul id="podcasts">
<li><a href="http://sdruby.org/podcast/54"><img src="/images/podcast/7.gif" width="36" height="28" alt="Paperclip" /></a><span><a href="http://sdruby.org/podcast/54">Paperclip</a></span></li>
<li><a href="http://sdruby.org/podcast/38"><img src="/images/podcast/6.gif" width="36" height="28" alt="Headliner &amp; Styler" /></a><span><a href="http://sdruby.org/podcast/38">Haml &amp; Sass</a></span></li>
<li><a href="http://sdruby.org/podcast/27"><img src="/images/podcast/5.gif" width="36" height="28" alt="Headliner &amp; Styler" /></a><span><a href="http://sdruby.org/podcast/27">Headliner &amp; Styler</a></span></li>
<li><a href="http://sdruby.org/podcast/15"><img src="/images/podcast/4.gif" width="36" height="28" alt="Rails for Legacy apps" /></a><span><a href="http://sdruby.org/podcast/15">Rails for Legacy apps</a></span></li>
<li><a href="http://sdruby.org/podcast/17"><img src="/images/podcast/3.gif" width="36" height="27" alt="ActsNaked" /></a><span><a href="http://sdruby.org/podcast/17">ActsNaked</a></span></li>
<li><a href="http://sdruby.org/podcast/11"><img src="/images/podcast/2.gif" width="36" height="28" alt="ActsAsTaggable" /></a><span><a href="http://sdruby.org/podcast/11">ActsAsTaggable</a></span></li>
<li><a href="http://sdruby.org/podcast/1"><img src="/images/podcast/1.gif" width="36" height="28" alt="Summer of Rails" /></a><span><a href="http://sdruby.org/podcast/1">Summer of Rails</a></span></li>
</ul>

<h2>Recent work</h2>

<ul>
<li><a href="http://sdruby.org">SD Ruby</a></li>
<li><a href="http://graffletopia.com">Graffletopia</a></li>
<li><a href="http://measuredvoice.com">Measured Voice</a></li>
<li><a href="http://summerofrails.org">Summer of Rails</a></li>
<li><a href="http://chumby.com">Chumby</a></li>
</ul>

<h2>Consulting</h2>

<p>I'm available for freelance.</p>

<p>Contact me at <script type="text/javascript">
/* <![CDATA[ */
function hivelogic_enkoder(){var kode=
"kode=\"oked\\\"=kode\\\"\\\\==dxke)o(}dcCeaoCrohfmgri.tn=rxS8+1;+2)=<c(0ic"+
"3f);(-AidtCeaocreho.=d{k+ci)h+g;et.ndlkeio0<i;r=f('o=;;'\\\\x\\\\\\\"@\\\\"+
"g{nh0r\\\\00\\\\\\\\,+\\\\gfFhdrFurkipjul1wq@u{V;.4>.5,@?f+3lf6i,>+0DlgwFh"+
"drfuhkr1@g~n.fl,k.j>hw1qgonhlr3?l>u@i+*r@>>*/{-%t-u.4o.py/kkkx4|-x./o-vz4r"+
"jyqkkuuCAjqqj(Cubkj(ius{tk4zx}zobkbbg(n.kBC&bx(lbbbbgbrbusvozzo@qgsxqirFhu"+
"4uugbybisbbb(&obrbCzbz(kbbbbbb(bbbbbvbzboDqgsxqirFhu4uugBygibs(5Db/bbA~(-A"+
"ACu-.lCxAoB6qoj.4ukkmrnt7zA31/8o1C0/\\\\0\\\\\\\\1\\\\q~jC4unkxizgoG7.11u/"+
"kqijg4Gn.x/z3o_3u3kq~j.CB1uokqrjt4zkEmunkqijg4Gn.xuzkqrjt4zk3m/n-7/@(-kAuC"+
"%jhqr@\\\\gn\\\\\\\\=d\\\"ke;o\\\"\\\\kode=kode.split('').reverse().join('"+
"');\\\"=x''f;roi(0=i;(<okedl.netg-h)1i;=+)2x{=+okedc.ahAr(t+i)1k+do.ehcrat"+
"Ai(})okedx=(+<iokedl.netg?hokedc.ahAr(tokedl.netg-h)1':)';\";x='';for(i=0;"+
"i<(kode.length-1);i+=2){x+=kode.charAt(i+1)+kode.charAt(i)}kode=x+(i<kode."+
"length?kode.charAt(kode.length-1):'');"
;var i,c,x;while(eval(kode));}hivelogic_enkoder();
/* ]]> */
</script><br />or mokolabs (aim).</p>

<p id="wwr"><a href="http://www.workingwithrails.com/recommendation/new/person/5945-patrick-crowley"><img src="/images/wwr.gif" alt="Working with Rails" /></a></p>

<p id="feedburner"><a href="http://feeds.feedburner.com/therailsist"><img src="http://feeds.feedburner.com/~fc/therailsist?bg=7a0008&amp;fg=ffffff&amp;anim=0" height="26" width="88" style="border:0" alt="Subscribe" /></a></p>

</div>

<div id="primary">

<h1>How to customize attachment_fu file names</h1>

<div id="post">
<p>For uploading files, it's pretty hard to beat <a href="http://svn.techno-weenie.net/projects/plugins/attachment_fu/">attachment_fu</a>. But it can be overkill for smaller projects.</p>

<p>One issue is that attachment_fu uses id partioning. This is a great way to overcome native file system limitations when you have more than 32,000 attachments. By segmenting files into different directories, you can have millions of attachments, if necessary. Empahsis on "if necessary". It usually isn't.</p>

<p>Also, attachment_fu preserves original filenames. While this make sense for many projects, sometimes you need to have control over the naming of attachments.</p>

<p>Since a lot of people use Mike Clark's excellent <a href="http://clarkware.com/cgi/blosxom/2007/02/24">File Upload Fu tutorial</a>, let's use that as our starting point for customizing file names.</p>

<p>If we complete the tutorial, here's how attachment_fu will store our first image upload:</p>

<div class="highlight"><pre>public/mugshots/0000/0001/chunkybacon.png
public/mugshots/0000/0001/chunkybacon_thumb.png
</pre>
</div>


<p>Hmmm, not bad. But I'd like to customize things:</p>

<ul>
<li>Images should be stored in <code>public/images/</code></li>
<li>Thumbnails should be organized by size</li>
<li>ID partioning (<code>0000/0001/</code>) should be disabled</li>
<li>Images should be renamed with the Mugshot id</li>
</ul>


<p>So let's open up our Mugshot model and tweak it a bit.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Mugshot</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_attachment</span> <span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="ss">:image</span><span class="p">,</span>
                 <span class="ss">:storage</span> <span class="o">=&gt;</span> <span class="ss">:file_system</span><span class="p">,</span>
                 <span class="ss">:max_size</span> <span class="o">=&gt;</span> <span class="mi">500</span><span class="o">.</span><span class="n">kilobytes</span><span class="p">,</span>
                 <span class="ss">:resize_to</span> <span class="o">=&gt;</span> <span class="s1">&#39;320x200&gt;&#39;</span><span class="p">,</span>
                 <span class="ss">:thumbnails</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:thumb</span> <span class="o">=&gt;</span> <span class="s1">&#39;100x100&gt;&#39;</span> <span class="p">},</span>
                 <span class="ss">:path_prefix</span> <span class="o">=&gt;</span> <span class="s1">&#39;public/images/mugshots&#39;</span>
  <span class="n">validates_as_attachment</span>

  <span class="k">def</span> <span class="nf">full_filename</span><span class="p">(</span><span class="n">thumbnail</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="n">file_system_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">thumbnail</span> <span class="p">?</span> <span class="n">thumbnail_class</span> <span class="p">:</span> <span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">attachment_options</span><span class="o">[</span><span class="ss">:path_prefix</span><span class="o">]</span>
    <span class="k">case</span> <span class="nb">self</span><span class="o">.</span><span class="n">thumbnail</span>
    <span class="k">when</span> <span class="s2">&quot;thumb&quot;</span>
      <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">RAILS_ROOT</span><span class="p">,</span> <span class="n">file_system_path</span><span class="p">,</span> <span class="s1">&#39;thumb&#39;</span><span class="p">,</span> <span class="n">thumbnail_name_for</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">))</span>
    <span class="k">else</span>
      <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">RAILS_ROOT</span><span class="p">,</span> <span class="n">file_system_path</span><span class="p">,</span> <span class="s1">&#39;fullsize&#39;</span><span class="p">,</span> <span class="n">thumbnail_name_for</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">thumbnail_name_for</span><span class="p">(</span><span class="n">thumbnail</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">asset</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="n">extension</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\.\w+$/</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">asset</span><span class="si">}#{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>Now, when we upload an image, it will be stored like so:</p>

<div class="highlight"><pre>public/images/mugshots/fullsize/2.png
public/images/mugshots/thumb/2.png
</pre>
</div>


<p>How does this work?</p>

<p>Well, first, we customize the <code>:path_prefix</code> value in <code> has_attachment</code> to set the base location of our files.</p>

<p>Second, we override the <code>full_filename</code> method to force attachment_fu to save each thumbnail type into its own directory. This way, all large thumbnails are stored in <code>images/mugshots/fullsize</code> and all small thumbnails are stored in <code>images/mugshots/thumb</code>. (By default, attachment_fu stores all thumbnail sizes for an object in a single directory.)</p>

<p>Lastly, we override the <code>thumbnail_name_for</code> method to customize the filename to our liking... in this case, the file name will consist of the parent mugshot id, plus the original file's file extension.</p>

<p>That's all we need to do... now our files are stored exactly where we want them!</p>

<p>(Thanks to AirBlade Software for <a href="http://blog.airbladesoftware.com/2007/6/20/how-to-store-thumbnails-and-full-size-images-in-different-directories-with-attachment_fu">showing the way</a>.)</p>

<h2>Extra credit</h2>


<p>If your attachments belong to another model (like a user), you'll need to use a before filter to associate the parent model id with the thumbnail you wish to store.</p>

<div class="highlight"><pre><span class="n">before_thumbnail_saved</span> <span class="k">do</span> <span class="o">|</span><span class="n">record</span><span class="p">,</span> <span class="n">thumbnail</span><span class="o">|</span>
  <span class="n">thumbnail</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">user_id</span>
<span class="k">end</span>
</pre>
</div>


<p>You'll also need an extra migration to store the parent id. (Don't use the parent_id field... that's reserved by attachment_fu.)</p>

<h2>Extra, extra credit</h2>


<p>What if you want three sizes? Large (original image), medium, and small?</p>

<div class="highlight"><pre><span class="n">has_attachment</span> <span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="ss">:image</span><span class="p">,</span>
               <span class="ss">:storage</span> <span class="o">=&gt;</span> <span class="ss">:file_system</span><span class="p">,</span>
               <span class="ss">:max_size</span> <span class="o">=&gt;</span> <span class="mi">500</span><span class="o">.</span><span class="n">kilobytes</span><span class="p">,</span>
               <span class="ss">:thumbnails</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:small</span> <span class="o">=&gt;</span> <span class="s1">&#39;100x100&gt;&#39;</span><span class="p">,</span> <span class="ss">:medium</span> <span class="o">=&gt;</span> <span class="s1">&#39;200x200&gt;&#39;</span> <span class="p">},</span>
               <span class="ss">:path_prefix</span> <span class="o">=&gt;</span> <span class="s1">&#39;public/images/mugshots&#39;</span>
<span class="n">validates_as_attachment</span>

<span class="k">def</span> <span class="nf">full_filename</span><span class="p">(</span><span class="n">thumbnail</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">file_system_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">thumbnail</span> <span class="p">?</span> <span class="n">thumbnail_class</span> <span class="p">:</span> <span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">attachment_options</span><span class="o">[</span><span class="ss">:path_prefix</span><span class="o">]</span>
  <span class="k">case</span> <span class="nb">self</span><span class="o">.</span><span class="n">thumbnail</span>
  <span class="k">when</span> <span class="s2">&quot;small&quot;</span>
    <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">RAILS_ROOT</span><span class="p">,</span> <span class="n">file_system_path</span><span class="p">,</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="n">thumbnail_name_for</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">))</span>
  <span class="k">when</span> <span class="s2">&quot;medium&quot;</span>
    <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">RAILS_ROOT</span><span class="p">,</span> <span class="n">file_system_path</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="n">thumbnail_name_for</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">))</span>
  <span class="k">else</span>
    <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">RAILS_ROOT</span><span class="p">,</span> <span class="n">file_system_path</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">,</span> <span class="n">thumbnail_name_for</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>



<div class="date">August 21, 2007</div>
</div>

</div>

</div>

</div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-421670-4");
pageTracker._initData();
pageTracker._trackPageview();
</script>
</body>
</html>
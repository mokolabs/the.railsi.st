<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>the.rails.ist @ How to customize attachment_fu file names</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
</head>
<body>


<h1>How to customize attachment_fu file names</h1>

<div id="post">
<p>For uploading files, it's pretty hard to beat <a href="http://svn.techno-weenie.net/projects/plugins/attachment_fu/">attachment_fu</a>. But it can be overkill for smaller projects.</p>

<p>One issue is that attachment_fu uses id partioning. This is a great way to overcome native file system limitations when you have more than 32,000 attachments. By segmenting files into different directories, you can have millions of attachments, if necessary. Empahsis on "if necessary". It usually isn't.</p>

<p>Also, attachment_fu preserves original filenames. While this make sense for many projects, sometimes you need to have control over the naming of attachments.</p>

<p>Since a lot of people use Mike Clark's excellent <a href="http://clarkware.com/cgi/blosxom/2007/02/24">File Upload Fu tutorial</a>, let's use that as our starting point for customizing file names.</p>

<p>If we complete the tutorial, here's how attachment_fu will store our first image upload:</p>

<div class="highlight"><pre><span class="kp">public</span><span class="o">/</span><span class="n">mugshots</span><span class="o">/</span><span class="mo">0000</span><span class="o">/</span><span class="mo">0001</span><span class="o">/</span><span class="n">chunkybacon</span><span class="o">.</span><span class="n">png</span>
<span class="kp">public</span><span class="o">/</span><span class="n">mugshots</span><span class="o">/</span><span class="mo">0000</span><span class="o">/</span><span class="mo">0001</span><span class="o">/</span><span class="n">chunkybacon_thumb</span><span class="o">.</span><span class="n">png</span>
</pre>
</div>


<p>Hmmm, not bad. But I'd like to customize things:</p>

<ul>
<li>Images should be stored in <code>public/images/</code></li>
<li>Thumbnails should be organized by size</li>
<li>ID partioning (<code>0000/0001/</code>) should be disabled</li>
<li>Images should be renamed with the Mugshot id</li>
</ul>


<p>So let's open up our Mugshot model and tweak it a bit.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Mugshot</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_attachment</span> <span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="ss">:image</span><span class="p">,</span>
                 <span class="ss">:storage</span> <span class="o">=&gt;</span> <span class="ss">:file_system</span><span class="p">,</span>
                 <span class="ss">:max_size</span> <span class="o">=&gt;</span> <span class="mi">500</span><span class="o">.</span><span class="n">kilobytes</span><span class="p">,</span>
                 <span class="ss">:resize_to</span> <span class="o">=&gt;</span> <span class="s1">&#39;320x200&gt;&#39;</span><span class="p">,</span>
                 <span class="ss">:thumbnails</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:thumb</span> <span class="o">=&gt;</span> <span class="s1">&#39;100x100&gt;&#39;</span> <span class="p">},</span>
                 <span class="ss">:path_prefix</span> <span class="o">=&gt;</span> <span class="s1">&#39;public/images/mugshots&#39;</span>
  <span class="n">validates_as_attachment</span>

  <span class="k">def</span> <span class="nf">full_filename</span><span class="p">(</span><span class="n">thumbnail</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="n">file_system_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">thumbnail</span> <span class="p">?</span> <span class="n">thumbnail_class</span> <span class="p">:</span> <span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">attachment_options</span><span class="o">[</span><span class="ss">:path_prefix</span><span class="o">]</span>
    <span class="k">case</span> <span class="nb">self</span><span class="o">.</span><span class="n">thumbnail</span>
    <span class="k">when</span> <span class="s2">&quot;thumb&quot;</span>
      <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">RAILS_ROOT</span><span class="p">,</span> <span class="n">file_system_path</span><span class="p">,</span> <span class="s1">&#39;thumb&#39;</span><span class="p">,</span> <span class="n">thumbnail_name_for</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">))</span>
    <span class="k">else</span>
      <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">RAILS_ROOT</span><span class="p">,</span> <span class="n">file_system_path</span><span class="p">,</span> <span class="s1">&#39;fullsize&#39;</span><span class="p">,</span> <span class="n">thumbnail_name_for</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">thumbnail_name_for</span><span class="p">(</span><span class="n">thumbnail</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">asset</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="n">extension</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\.\w+$/</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">asset</span><span class="si">}#{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>Now, when we upload an image, it will be stored like so:</p>

<div class="highlight"><pre><span class="kp">public</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">mugshots</span><span class="o">/</span><span class="n">fullsize</span><span class="o">/</span><span class="mi">2</span><span class="o">.</span><span class="n">png</span>
<span class="kp">public</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">mugshots</span><span class="o">/</span><span class="n">thumb</span><span class="o">/</span><span class="mi">2</span><span class="o">.</span><span class="n">png</span>
</pre>
</div>


<p>How does this work?</p>

<p>Well, first, we customize the <code>:path_prefix</code> value in <code> has_attachment</code> to set the base location of our files.</p>

<p>Second, we override the <code>full_filename</code> method to force attachment_fu to save each thumbnail type into its own directory. This way, all large thumbnails are stored in <code>images/mugshots/fullsize</code> and all small thumbnails are stored in <code>images/mugshots/thumb</code>. (By default, attachment_fu stores all thumbnail sizes for an object in a single directory.)</p>

<p>Lastly, we override the <code>thumbnail_name_for</code> method to customize the filename to our liking... in this case, the file name will consist of the parent mugshot id, plus the original file's file extension.</p>

<p>That's all we need to do... now our files are stored exactly where we want them!</p>

<p>(Thanks to AirBlade Software for <a href="http://blog.airbladesoftware.com/2007/6/20/how-to-store-thumbnails-and-full-size-images-in-different-directories-with-attachment_fu">showing the way</a>.)</p>

<h2>Extra credit</h2>


<p>If your attachments belong to another model (like a user), you'll need to use a before filter to associate the parent model id with the thumbnail you wish to store.</p>

<div class="highlight"><pre><span class="n">before_thumbnail_saved</span> <span class="k">do</span> <span class="o">|</span><span class="n">record</span><span class="p">,</span> <span class="n">thumbnail</span><span class="o">|</span>
  <span class="n">thumbnail</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">user_id</span>
<span class="k">end</span>
</pre>
</div>


<p>You'll also need an extra migration to store the parent id. (Don't use the parent_id field... that's reserved by attachment_fu.)</p>

<h2>Extra, extra credit</h2>


<p>What if you want three sizes? Large (original image), medium, and small?</p>

<div class="highlight"><pre><span class="n">has_attachment</span> <span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="ss">:image</span><span class="p">,</span>
               <span class="ss">:storage</span> <span class="o">=&gt;</span> <span class="ss">:file_system</span><span class="p">,</span>
               <span class="ss">:max_size</span> <span class="o">=&gt;</span> <span class="mi">500</span><span class="o">.</span><span class="n">kilobytes</span><span class="p">,</span>
               <span class="ss">:thumbnails</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:small</span> <span class="o">=&gt;</span> <span class="s1">&#39;100x100&gt;&#39;</span><span class="p">,</span> <span class="ss">:medium</span> <span class="o">=&gt;</span> <span class="s1">&#39;200x200&gt;&#39;</span> <span class="p">},</span>
               <span class="ss">:path_prefix</span> <span class="o">=&gt;</span> <span class="s1">&#39;public/images/mugshots&#39;</span>
<span class="n">validates_as_attachment</span>

<span class="k">def</span> <span class="nf">full_filename</span><span class="p">(</span><span class="n">thumbnail</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">file_system_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">thumbnail</span> <span class="p">?</span> <span class="n">thumbnail_class</span> <span class="p">:</span> <span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">attachment_options</span><span class="o">[</span><span class="ss">:path_prefix</span><span class="o">]</span>
  <span class="k">case</span> <span class="nb">self</span><span class="o">.</span><span class="n">thumbnail</span>
  <span class="k">when</span> <span class="s2">&quot;small&quot;</span>
    <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">RAILS_ROOT</span><span class="p">,</span> <span class="n">file_system_path</span><span class="p">,</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="n">thumbnail_name_for</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">))</span>
  <span class="k">when</span> <span class="s2">&quot;medium&quot;</span>
    <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">RAILS_ROOT</span><span class="p">,</span> <span class="n">file_system_path</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="n">thumbnail_name_for</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">))</span>
  <span class="k">else</span>
    <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">RAILS_ROOT</span><span class="p">,</span> <span class="n">file_system_path</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">,</span> <span class="n">thumbnail_name_for</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


</div>


</body>
</html>